# Java锁机制

[toc]



对象的结构

对象头、实例数据、填充字节（保证对象是8bit的整数倍）

对象头：markword、class pointer。

markword结构：

挂起、唤醒线程需要切换为内核态，重量级。

引入偏向锁、轻量级锁。

锁只能升级。



无锁：1.无竞争 2.存在竞争，但不上锁，采用CAS。

偏向锁：对象认识线程，该线程来后，对象直接交出锁。看markword结构。如果对象发送当前线程不是老顾客，则升级为轻量级锁。

轻量级锁：



锁的四种状态：

无锁：基于CAS机制。

偏向锁：减少在没有竞争的条件下获取锁的代价。

轻量级锁：第二个线程竞争偏向锁时，升级为轻量级锁。

重量级锁：多个线程竞争轻量级锁时，超过一定的自旋次数。



核心：最好的情况下是基于CAS机制，其次是让拥有锁的对象记住线程id，最差的情况是使用`monitorenter`和`monitorexit`



monitor依赖于操作系统的mutex lock。挂起唤醒线程都会切换操作系统的内核态。



synchronized引入了偏向锁、轻量级锁和重量级锁。
