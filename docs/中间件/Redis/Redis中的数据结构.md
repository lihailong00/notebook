# Redis中的数据结构

[toc]

## 字符串

Redis不直接使用C字符串，而要自定义简单动态字符串（SDS）。原因如下：

1. 获取字符串长度需要通过运算。
2. C字符串不可修改。

SDS的结构如下（其中一种SDS的结构）：

```c
struct __attribute__ ((__packed__)) sdshdr8 {
    uint8_t len;  /* buf已保存的字符串字节数，不包含结束标识 */
    uint8_t alloc;  /* buf申请的总的字节数，不包含结束标识 */
    unsigned char flags;  /* 不同的SDS的头类型，用来控制SDS的头大小 */
    char buf[];
}
```

例如：一个字符串“name”的sds结构如下：

| len:4 | alloc:4 | flags:1 | n    | a    | m    | e    | \0   |
| ----- | ------- | ------- | ---- | ---- | ---- | ---- | ---- |



Redis SDS  扩容细节：

假定当前有字符串“hi”的SDS：

| len:2 | alloc:2 | flags:1 | h    | i    | \0   |
| ----- | ------- | ------- | ---- | ---- | ---- |

此时我们要追加字符串“lhl”，则会申请一个新的内存空间。

- 如果新字符串小于1M，则新空间为扩展后的字符串长度的2倍+1（加上\0）。

- 如果新字符串大于1M，则新空间为拓展后的字符串长度+1M+1。

这叫做内存预分配。

此时字符串“hilhl”的SDS为：

| len:5 | alloc:11 | flags:1 | h    | i    | l    | h    | l    | \0   |      |      |      |      |      |
| ----- | -------- | ------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |

