# Redis作为消息队列的思考

[toc]



## 项目背景

我独立开发的【小南校园】微信小程序中有一个下载试卷的功能，用户点击下载后，只需要填写自己的邮箱，过一段时间就可以在邮箱中收到电子版试卷。在<u>点击下载</u>到<u>接收邮件</u>的这段过程中，用户可以做其他事情。

目前小程序的用户数量为300+，下载请求量不大。

目前整个后端服务部署在一台2核4G的服务器上。



## 技术细节

这个功能可以采用一个生产者-消费者模型解决。这个模型中总共有3类角色：生产者、消息中间件、消费者。生产者即为发出下载请求的用户，消费者即为处理并响应下载请求的服务器。生产者产生一个下载请求后，只需要一个消费者处理该下载请求即可。

需要注意的技术难点有：

1. 如何保证生产者成功将消息加入到消息队列。
2. 如何保证技术在服务宕机的情况下，消息队列中的请求不会丢失。
3. 如果消费者取出消息队列中的消息后，如果没有成功消费消息（例如邮件系统故障），该如何保证这条消息之后还能被消费。
4. 如果大量消息堆满了消息队列，该怎么处理？（基于目前的用户量，应该不会出现这种问题，因此暂未考虑这种问题）
5. 服务出现故障后（比如生产者一直无法将消息放入消息队列，或者消费者一直无法消费消息队列中的消息，或者服务突然宕机），建立合理的预警措施（比如记录日志，或者立即通知管理员）。但是在该项目中我没有设定这些措施，因为对于个人项目来说，我没有太多精力采用这些策略。如果将来有可能用到这些预警措施，我会放弃Redis实现消息队列，转而采用主流的消息队列，因为主流的消息队列往往自带这些功能。



## 消息队列选型

目前市面上主流的消息队列有RocketMQ，RabbitMQ......也可以采用一些中间件（比如Redis）模拟消息队列。甚至可以直接在Java程序中开辟一个内存空间，作为消息队列。

在这个项目中，我采用了Redis模拟消费队列。理由如下：

1. 引入RocketMQ等主流消息队列会占用额外的资源，而我的服务器配置低，资源有限。
2. 引入新的中间件就让项目多了一些不可控因素，尤其是对于我这样的小白。
3. 该项目的情景非常简单，也即多个生产者、一个消费队列和一个消费者。
4. 服务的请求量较小，不太可能发生消息挤压的情况。
5. 数据并不重要，即便丢失也不会产生较为严重的后果（况且我采用了有效的措施，在最大程度上保证了数据不丢失）。



## 项目实战





## 项目展望

1. 基于编码的层面，在生产者-消费者模型中，使用Redis模拟消息队列时，如何实现生产者和消费者的解耦？可以采用命令模式、观察者模式等。
