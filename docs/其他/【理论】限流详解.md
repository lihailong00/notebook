# 限流详解

[toc]



## 限流的分类

按照限流的作用范围，可以分为单机限流和分布式限流；根据限流方式，又分为**计数器**、**滑动窗口**、**漏桶限流**和**令牌桶限流**。

我们主要讨论限流方式。



## 常见限流方式

### 计数器限流

计数器是一种最简单限流算法，其原理就是：在一段时间间隔内，对请求进行计数，与阈值进行比较判断是否需要限流。一旦到了时间临界点，将计数器清零。

这种方法虽然简单，但也有个大问题就是**没有很好的处理单位时间的边界**，参考下图即可明白。

![img](https://figurebed-1309161819.cos.ap-nanjing.myqcloud.com/typora/7ba261bc04c7442b8d93d6c159b7a992~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

该方法也存在一个潜在的问题：这个计数引用了锁，在高并发场景，这个方式可能不太实用，建议将锁去掉，然后将`count++`的逻辑通过原子计数处理，这样就可以保证`count`自增时不会被多个线程同时执行，**即通过原子计数的方式实现限流。**



### 滑动窗口限流

滑动窗口限流完善了计数器限流的短板，也即**在单位时间边界遭受大量的请求攻击**。

具体方案如下：将一段时间划成N份，每次将滑动窗口往后移动1份。我们需要保证滑动窗口在任意时刻最多接受M次请求。



### 漏桶限流

一个固定容量的桶，有水流进来，也有水流出去。对于**流进来的水（请求速度）**来说，我们无法预计一共有多少水会流进来，也无法预计水流的速度。但是对于流出去的水来说，这个桶可以固定**水流出的速率（处理速度）**，从而达到流量整形和流量控制的效果。

漏桶算法有以下特点：

- 漏桶具有固定容量，出水速率是固定常量（流出请求）。
- 如果桶是空的，则不需流出水滴。
- 水滴可以以任意速率流入到漏桶（流入请求）。
- 如果流入水滴超出了桶的容量，则流入的水滴溢出（新请求被拒绝）。



### 令牌桶限流

令牌桶算法（Token Bucket）是网络流量整形（Traffic Shaping）和速率限制（Rate Limiting）中最常使用的一种算法。典型情况下，令牌桶算法用来控制发送到网络上的数据的数目，并允许突发数据的发送。

我们有一个固定的桶，桶里存放着令牌（token）。一开始桶是空的，系统按固定的时间（rate）往桶里添加令牌，直到桶里的令牌数满，多余的令牌会被丢弃。当请求来的时候，从桶里移除一个令牌，如果桶是空的则拒绝**请求**或者**阻塞**。

令牌桶有以下特点：

- 令牌按固定的速率被放入令牌桶中。
- 桶中最多存放 B 个令牌，当桶满时，新添加的令牌被丢弃或拒绝。
- 如果桶中的令牌不足 N 个，则不会删除令牌，且请求将被限流（丢弃或阻塞等待）。

令牌桶限制的是平均流入速率（允许突发请求，只要有令牌就可以处理，支持一次拿3个令牌，4个令牌...），并允许一定程度突发流量，所以也是非常常用的限流算法。



### 思考

Q：令牌桶相比于漏桶算法，有哪些优势？

A：漏桶算法的**处理请求速率**是固定的，而令牌桶算法的处理请求速率是动态变化的（但一段时间内平均处理速率也是固定的，因为令牌放入令牌桶的速率是固定的），一定程度上可以更好的应对突发流量。