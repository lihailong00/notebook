# 缓存一致性

[toc]



## 什么是数据一致性

强一致性：系统写入的是什么，读出的就是什么。实现时对系统的性能有较大的影响。

弱一致性：系统写入成功后，不保证立即读出刚写入的值。

最终一致性：属于弱一致性，系统写入成功后，保证在一段时间后读出刚写入的值。



## 缓存更新策略

> 以下只能保证最终一致性。



### Cache-Aside Pattern（重要）

**核心：记住读流程和写流程即可。**



> 读流程

```
读请求
  |
  |-----------------
  ↓                |
是否命中缓存         |
  |                |
  |  缓存未命中      |
  ↓                |
从数据库读取数据      |
  |                |
  |                |
  ↓                |
更新缓存            |
  |                |
  |                |
  ↓                |
返回数据 <-----------
```



> 写流程

```
写请求------>更新数据库------>删除旧的缓存
```





> 问题1. 为什么是删除缓存，而不是更新缓存？

答案：假定采用更新缓存。那么写的过程是：先更新数据库，再更新缓存。

假定数据库和缓存中a=1，请求A负责改写a=2，请求B负责改写a=3。请求B晚于请求A。

```
                  由于网络问题，A更新缓存延时
请求A--->更新数据库a=2--------------->更新缓存a=2
      请求B--->更新数据库a=3--->更新缓存a=3
```

最终数据库中a=3，缓存中a=2。



> 问题2. 为什么要先更新数据库，再删除缓存？

答案：假定请求A早于请求B，如下图所示

```
               由于网络问题，A更新缓存延时
请求A--->查询数据库a=1------------>更新缓存a=1
    请求B--->更新数据库a=2--->更新缓存a=2
```



> 问题3. 如果我执意要先删除缓存，再更新数据库，如何保证一致性？（看上去挺无理，但是也有这种场景）

答案：

1. 延时双删：更新数据时，先删除缓存，再删除数据库，过一段时间再删除缓存。
2. 删除缓存重试机制：如果“延时双删”失败，那么多删几次，直到删除成功！
3. 读取`binlog`异步删除缓存：使用阿里的canal将`binlog`日志采集发送到MQ队列里面，然后通过ACK机制确认处理这条更新消息，删除缓存，保证数据缓存一致性。



### Read-Through/Write-Through

> 读流程

```
读请求
  |
  |-----------------
  ↓                |
是否命中缓存         |
  |                |
  |  缓存未命中      |
  ↓                |
从数据库读取数据      |
  |                |
  |                |
  ↓                |
更新缓存            |
  |                |
  |                |
  ↓                |
返回数据 <-----------
```



> 写流程

和cache-aside pattern几乎一样，唯一不同的地方是多了一个**缓存抽象层**。

![Write-Through流程](https://figurebed-1309161819.cos.ap-nanjing.myqcloud.com/typora/bb1eaafc6ab14ca98fe603fad1fb7fc5~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)





### Write Behind 异步缓存写入

由`Cache Provider`来负责缓存和数据库的读写。**Write Behind**只更新缓存，不直接更新数据库，通过**批量异步**的方式来更新数据库。

缓存和数据库的**一致性不强**，**适合频繁写**的场景，对一致性要求高的系统要谨慎使用。

![Write behind流程](https://figurebed-1309161819.cos.ap-nanjing.myqcloud.com/typora/81197a8c7a164b0b9a76b8380ae29a4b~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

